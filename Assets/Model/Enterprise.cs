//------------------------------------------------------------------------------
// <auto-generated>
//     Этот код создан программой.
//     Исполняемая версия:4.0.30319.34014
//
//     Изменения в этом файле могут привести к неправильной работе и будут потеряны в случае
//     повторной генерации кода.
// </auto-generated>
//------------------------------------------------------------------------------
using System;
using System.Collections.Generic;
using MySql.Data.MySqlClient;

namespace Model
{
	public class Enterprise
	{
		public Int64 Id { get; set; }
		public string Title { get; set; }
		public decimal Balance { get; set; }
		public double Stationary { get; set; }
		public Int16? Type { get; set; }

		public Int64 Taxation_id { get; set; }

		public virtual Taxation Taxation { get; set; }

		public virtual ICollection<Asset> Assets {get; set;}
		public virtual ICollection<Competitor> Competitors {get; set;}
		public virtual ICollection<Employee> Employees {get; set;}
		public virtual ICollection<Enterprise_docs> Enterprise_docs {get; set;}
		public virtual ICollection<Equipment> Equipment {get; set;}
		public virtual ICollection<Revenue> Revenues {get; set;}
		public virtual ICollection<Enterprise_equipment> Enterprise_equipment {get; set;}

		public Enterprise (Int64 id, string title, decimal balance, double stationary, 
		                   Int16? type, Int64 taxation_id)
		{
			Id = id;
			Title = title;
			Balance = balance;
			Stationary = stationary;
			Type = type;
			Taxation_id = taxation_id;
		}

		public void PaySalary(MySqlConnection connection, Employee employee, int hours_worked, DateTime date)
		{
			Salary_payment salary_payment = new Salary_payment (0, DateTime.Now, hours_worked, 
			                                                    (decimal?)(hours_worked * employee.Qualification), employee.Id);
			Salary_paymentDAO.InsertSalary_payments (connection, new List<Salary_payment> () { salary_payment });

			List<Project> projects = ProjectDAO.GetProjects (connection);
			string Query;


			foreach (Project project in projects) 
			{
				Query = "SELECT sum(Salary_payment.salary) as salary FROM Salary_payment, Employee, Team_member, Project" +
					"WHERE Employee.Id=Salary_payment.Employee_id AND" +
						"Employee.Id = Team_member.Employee_id AND Team_member.Project_id = Project.id " +
						"AND Salary_payment.`date`='" + date + "' AND Project.id=" + project.Id + ";";
				MySqlCommand command = connection.CreateCommand();
				command.CommandText = Query;
				MySqlDataReader data = command.ExecuteReader();

				while (data.Read()){
					project.Expenditures += Convert.ToDecimal(data["salary"]);
				}

				this.Balance -= project.Expenditures;

			}
			ProjectDAO.UpdateProjects (connection, projects);
		}



	}
}